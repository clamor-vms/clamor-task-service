{
    "Title": "Clamor Task Service",
    "Commands": {
        "_pack": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "build",
                            "-f",
                            "./Dockerfile",
                            "-t",
                            "${DOCKER_REG}/clamor/task-service",
                            "."
                        ]
                    }
                }
            ]
        },

        "_upload": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "push",
                            "${DOCKER_REG}/clamor/task-service"
                        ]
                    }
                }
            ]
        },

        "build": {
            "Requires": ["_pack", "_upload"],
            "Steps": []
        },
        
        "deploy": {
            "Requires": ["build"],
            "Steps": [
                {
                    "Type": "EnsureSecret",
                    "Args": {
                        "Key": "clamor-task-service-mysql-password"
                    }
                },
                {
                    "Type": "EnsureSecret",
                    "Args": {
                        "Key": "clamor-task-service-mysql-root-password"
                    }
                },
                {
                    "Type": "CopyFile",
                    "Args": {
                        "Source": "k8s/deployment.template.yaml",
                        "Target": "deployment.yaml"
                    }
                },
                {
                    "Type": "RunTemplate",
                    "Args": {
                        "File": "deployment.yaml"
                    }
                },
                {
                    "Type": "DoublePipeCommand",
                    "Args": {
                        "Source": [
                            "cat",
                            "deployment.yaml"
                        ],
                        "Target1": [
                            "envsubst"
                        ],
                        "Target2": [
                            "kubectl",
                            "apply",
                            "-f",
                            "-"
                        ]
                    }
                }
            ]
        },

        "run": {
            "Requires": ["_pack"],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "./src/task",
                            "serve"
                        ]
                    }
                }
            ]
        },

        "stop": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "kubectl",
                            "delete",
                            "deployments,services,pods,pv,pvc,cronjob,job",
                            "--all"
                        ]
                    }
                }
            ]
        },

        "clean": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "rm",
                            "-rf",
                            "${DIR}/working/mysql"
                        ]
                    }
                }
            ]
        }
    }
}
